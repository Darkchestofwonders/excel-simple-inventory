{"version":"0.3.0","body":"function main(workbook: ExcelScript.Workbook) {\n  // Get worksheets and table\n  const selectedSheet = workbook.getWorksheet(\"Product Form\");\n  const databaseSheet = workbook.getWorksheet(\"Database & Calc\");\n  const oppTable = databaseSheet.getTable(\"movementData\");\n\n  // Read form values \n  let productName = selectedSheet.getRange(\"H5\").getValue();  // Customer / Client Name\n  let movementType = selectedSheet.getRange(\"S5\").getValue();  // Movement Type (e.g., Receipt / Issue)\n  let purchaseOrder = selectedSheet.getRange(\"S7\").getValue(); // PO\n  let valueCell = selectedSheet.getRange(\"V5\").getValue();     // Movement Value\n  let dateValue = selectedSheet.getRange(\"Y5\").getValue();     // Date\n  let notes = selectedSheet.getRange(\"S9\").getValue();         // Notes (merged S9:V9)\n\n  //  Validate required fields \n  if (productName === \"\") {\n    throw new Error(\"A Product (H5) is required.\");\n  }\n\n  if (!movementType || movementType.toString().trim() === \"\") {\n    throw new Error(\"Movement Type (S5) is required.\");\n  }\n\n  if (valueCell === \"\" || valueCell === null || isNaN(Number(valueCell))) {\n    throw new Error(\"Qty (V5) must be a valid number.\");\n  }\n\n  // Normalize strings for logic\n  const movementTypeLower = movementType.toString().trim().toLowerCase();\n  const purchaseOrderLower = purchaseOrder?.toString().trim().toLowerCase();\n\n  // Enforce PO requirement for Receipts \n  if (!purchaseOrderLower && movementTypeLower === \"receipt\") {\n    throw new Error(\"PO (S7) is required for a receipt.\");\n  }\n\n  // If movement type is 'Issue', make value negative \n  if (movementTypeLower === \"issue\") {\n    valueCell = -Math.abs(Number(valueCell));\n  }\n\n  // If notes havent been entered make it a spaces so the value isn't shown as 0 \n  if (notes === \"\") {\n    notes = \" \";\n  }\n\n  // Build the row data \n  const formValues = [\n    productName,\n    movementType,\n    purchaseOrder,\n    valueCell,\n    dateValue,\n    notes\n  ];\n\n  // Add the formValues as a new row in the movementData table \n  oppTable.addRow(-1, formValues);\n\n  // Clear form inputs safely (handles merged cells)\n  const rangesToClear: string[] = [\n    \"S5\",    // Movement Type\n    \"V5\",    // Value\n    \"Y5\",    // Possibly a date input\n    \"S7\",    // PO\n    \"S9:V9\"  // Notes (merged cell)\n  ];\n\n  for (let address of rangesToClear) {\n    try {\n      const range = selectedSheet.getRange(address);\n      range.clear(ExcelScript.ClearApplyTo.contents);\n    } catch (error) {\n      console.log(`Could not clear range ${address}: ${error}`);\n    }\n  }\n\n  // Set Y5 to today's date \n  selectedSheet.getRange(\"Y5\").setFormulaLocal(\"=TODAY()\");\n\n  // Refind the Product and update the stock numbers on screen\n  \n  const findSheet = workbook.getWorksheet(\"Product Form\");\n  const detailSheet = workbook.getWorksheet(\"Database & Calc\");\n\n  // Get product name from cell H5 \n  const prodName = findSheet.getRange(\"H5\").getValue() as string;\n\n  // Get the 'custTable' table \n  const prodTable = detailSheet.getTable(\"ProductData\");\n  const tableRows = prodTable.getRangeBetweenHeaderAndTotal().getValues();\n  const headers = prodTable.getHeaderRowRange().getValues()[0];\n\n  // Get column indices \n  const productIndex = headers.indexOf(\"Product #\");\n  const qtyOnHandIndex = headers.indexOf(\"Qty on Hand\");\n  const stockValueIndex = headers.indexOf(\"Stock Value\");\n\n  const reorderQtyIndex = headers.indexOf(\"Reorder Qty\");\n\n  // Search for matching customer \n  let found = false;\n  for (let i = 0; i < tableRows.length; i++) {\n    const row = tableRows[i];\n    if (row[productIndex]?.toString().toLowerCase() === prodName.toLowerCase()) {\n      findSheet.getRange(\"H21\").setValue(row[qtyOnHandIndex]);\n      findSheet.getRange(\"K21\").setValue(row[stockValueIndex]);\n      findSheet.getRange(\"K25\").setValue(row[reorderQtyIndex]);\n      found = true;\n      break;\n    }\n  } \n\n}","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}