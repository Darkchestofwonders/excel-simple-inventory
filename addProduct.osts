{"version":"0.3.0","body":"function main(workbook: ExcelScript.Workbook) {\n    // Get worksheets and table\n    const selectedSheet = workbook.getWorksheet(\"Product Form\");\n    const databaseSheet = workbook.getWorksheet(\"Database & Calc\");\n    const clientTable = databaseSheet.getTable(\"ProductData\");\n    const tableBodyRange = clientTable.getRangeBetweenHeaderAndTotal();\n    const tableData = tableBodyRange.getValues();\n\n    // Read form values\n    const formValues = [\n        selectedSheet.getRange(\"H5\").getValue(),  // Product\n        \"\",                                       // Fudge for Delete Flag\n        selectedSheet.getRange(\"H7\").getValue(),  // Description\n        selectedSheet.getRange(\"H9\").getValue(),  // UOM\n        selectedSheet.getRange(\"K9\").getValue(),  // Category\n        selectedSheet.getRange(\"H11\").getValue(), // EAN\n        selectedSheet.getRange(\"H15\").getValue(), // Supplier\n        selectedSheet.getRange(\"H17\").getValue(), // Unit Price\n        selectedSheet.getRange(\"K17\").getValue(), // Last Purchased\n        \"=SUMIF(movementData[Product '#],[@[Product '#]],movementData[Qty])\",  // Qty On Hand \n        \"=+[@[Unit Price]]*[@[Qty on Hand]]\",     // Stock Value\n        selectedSheet.getRange(\"H23\").getValue(), // Sock Location\n        selectedSheet.getRange(\"H25\").getValue(), // Reorder Point\n        \"=IF([@[Qty on Hand]]<[@[Reorder Point]],+[@[Reorder Point]]-[@[Qty on Hand]],0)\", // Qty to Order\n        \"=+[@[Reorder Qty]]*[@[Unit Price]]\",     // PO Commitement\n        selectedSheet.getRange(\"H27\").getValue(), // Notes\n    ];\n\n    const productInput = formValues[0]?.toString().trim().toLowerCase();\n\n    if (!productInput) {\n        throw new Error(\"Product (H5) is required to add or update the entry.\");\n    }\n\n    // Get header row to find 'full name' column index\n    const headers = clientTable.getHeaderRowRange().getValues()[0];\n    const fullNameColIndex = headers.findIndex(h => h.toString().toLowerCase() === \"product #\");\n\n    if (fullNameColIndex === -1) {\n        throw new Error(\"'Product #' column not found in ProductData table.\");\n    }\n\n    // Flag to track whether an update happened\n    let updated = false;\n\n    for (let i = 0; i < tableData.length; i++) {\n        const row = tableData[i];\n        const existingFullName = row[fullNameColIndex]?.toString().trim().toLowerCase();\n\n        if (existingFullName === productInput) {\n            // Match found: update this row\n            const rowRange = tableBodyRange.getRow(i);\n            for (let col = 0; col < formValues.length; col++) {\n                rowRange.getCell(0, col).setValue(formValues[col]);\n            }\n            updated = true;\n            break;\n        }\n    }\n\n    if (!updated) {\n        // No match found: add new row\n        clientTable.addRow(null, formValues);\n    }\n\n    // Clear form inputs \n    const cellsToClear: string[] = [\"H5\", \"N3\", \"H7:K7\", \"H9\", \"K9\", \"H11:I11\", \"H15:I15\", \"H17\",\"K17\",\"H21\", \"K21\", \"H23\", \"H25\", \"H27:K27\"];\n    for (let i = 0; i < cellsToClear.length; i++) {\n        const cellRef: string = cellsToClear[i];\n        const range = selectedSheet.getRange(cellRef);\n        range.clear(ExcelScript.ClearApplyTo.contents);\n    }\n\n}","description":"","noCodeMetadata":"","parameterInfo":"{\"version\":1,\"originalParameterOrder\":[],\"parameterSchema\":{\"type\":\"object\",\"default\":{},\"x-ms-visibility\":\"internal\"},\"returnSchema\":{\"type\":\"object\",\"properties\":{}},\"signature\":{\"comment\":\"\",\"parameters\":[{\"name\":\"workbook\",\"comment\":\"\"}]}}","apiInfo":"{\"variant\":\"synchronous\",\"variantVersion\":2}"}